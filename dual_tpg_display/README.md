# Dual-TPG display demo
This project displays video generated by Xilinx Video Test Pattern Generator(TPG) on a remote host through ethernet(lwip/UDPï¼‰
> vivado & SDK 2018.2 @ zedboard

## Hardware discription
![overview](https://github.com/wangyipengw1p/zynq/blob/master/dual_tpg_display/pic/hardware.png)
Basically, 2 tpg are connected to two VDMA respectively.
#### TPG
The max frame size is set to 1920*1080. Smaller size means less logic utilization.
#### VDMA
Only write channel is enabled. Frame buffer number is set to 3, which means tripple buffering. Sync mode is set to turser, which means the
sync signal is provided by AXI bus from source. Two interrupt is concated and connected to IRQ of zynq ps.
#### zynq configuration
[ps-pl HP, ethernet0, UART0, EMIO(with ethernet reset), 100MHz pl fabric clk, fabric interrupt IRQ] are enabled.

## Software discription
The main software project is `display`. There are also other reference projects in the package, please refer to the README.txt of them
 respectively.
#### file discription
`display_demo.h` contains some user defined parameters, check before running.
The main application is in `main.c`, which also contains init function for tpg 
and VDMA, call back funcion for VDMA frame counter interruption.
`udp_server.c` contains the init function for ethernet part, receive callback 
function and a function for transferring video data.
`vdma.c` contains APIs for controling VDMA
`zynq_interrupt.c` contains APIS for interruption.
Other file may not be intersting.
#### v_tpg
For reconfiguring the tpg pattern, referring the `init_pkg()` function and the
library(APIs): `xv_tpg.h`.
Please check the documentation for detailed function discriptions (google 
"xilinx tpg" and check for the register space defination) and required function 
call sequence.
#### VDMA
Only S2MM channel is enabled, which is for writing to DDR. Tripple buffer is set. 
The init_VDMA function does the initialization accordingly.
This design doesn't use AXI interrupt controller.
Frame counter will generate interrupt every frame.
please referring the the example design on `system.mms` page in bsp.
#### Ethernet(lwip)

> This project rely on [lwip 2.0.2 library](https://www.xilinx.com/support/documentation/application_notes/xapp1026.pdf).
So make sure that lwip 2.0.2 is enabled in bsp setting.
(in previous version of lwip, `ip_addr` is a struct, but in this version a pointer)

> If there're errors concerning alloc fail, please try larger value for such as pbuf_size
pbuf_pool_size. (also in bsp setting)

This module will provide application layer support for a UDP server.
In the main application DHCP is enabled, if failed or time out, static ip address set in main.c will be used
(mac address is set in main())

Please call "xemacif_input(netif);" from time to time, for example put it in a loop, which 
will check for received data and call interrupt.(note that it's interrput on CPU side, not IRQ
from PL)

#### protcol

Receiving x"010101"(char[3]), zynq will start sending video data to the remote host.

Receiving x"010100"(char[3]), zynq will stop sending video data.

Every tx UDP packet contains 5 byte header and one row of data.

Byte|Name|Discription
:-:| :-:| ---
 0 | Channel | 0 for channel 0 from tpg_0, 1 for tpg_1
 1 | Frmae ID| This byte is designed for client, which is used to distinguish consecutive frame
 2-4 | UDP packet Num | Used for UDP packet sorting
 5-end | Video data | One packet contains data of one row of pixels, which is defined in `display_demo.h` 

## Client for host
The example client for host is in `python_client_for_host` folder.
> Currently, `pygame` package is used for display, which is **not** fast enough for smooth video display.
## Run

## Performance

...
0.0704948902130127
0.07044839859008789
0.07045841217041016
0.07036709785461426
0.07038235664367676
0.07039141654968262
0.07047843933105469
0.07024979591369629
0.07040810585021973
0.07039713859558105
0.0704808235168457
0.07043743133544922
0.07039141654968262
0.07041215896606445
0.07042407989501953
0.07041430473327637
0.07028079032897949
0.07047533988952637
0.07044601440429688
0.0704801082611084
...


Above is a interception of interval time of receiving 1920*1080 frames. So the bandwidth of ethernet is roughly 
> 0.704^-1 * 1920*1080 * 24 = 709.9 Mb/s

